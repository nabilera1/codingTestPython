# https://stackoverflow.com/questions/60625952/find-inflexion-point-of-a-numpy-array-curve
import matplotlib.pyplot as plt
from scipy import signal
import numpy as np
import matplotlib.pyplot as plt

arr = [124, 122, 118, 124, 119, 121, 123, 119, 120, 123, 123, 122, 122, 123, 123, 120, 121, 126, 122, 125, 124, 125,
       125, 128, 125, 128, 128, 130, 128, 130, 131, 132, 131, 130, 129, 132, 132, 133, 131, 134, 133, 134, 132, 136,
       133, 132, 138, 134, 137, 137, 140, 140, 139, 140, 141, 142, 140, 143, 141, 142, 141, 142, 147, 144, 145, 145,
       146, 148, 145, 147, 147, 149, 149, 148, 154, 149, 149, 153, 151, 154, 156, 156, 157, 156, 156, 157, 158, 159,
       158, 160, 161, 161, 163, 163, 167, 167, 164, 166, 168, 166, 167, 169, 169, 165, 169, 172, 170, 173, 175, 175,
       174, 174, 177, 178, 180, 183, 184, 184, 185, 191, 190, 199, 197, 206, 215, 226, 239, 247, 268, 286, 306, 331,
       363, 389, 426, 461, 501, 546, 593, 637, 686, 735, 791, 841, 898, 957, 1014, 1074, 1134, 1201, 1260, 1323, 1395,
       1458, 1516, 1582, 1655, 1719, 1784, 1859, 1932, 1998, 2066, 2140, 2208, 2276, 2342, 2416, 2491, 2555, 2628, 2702,
       2774, 2839, 2909, 2979, 3049, 3111, 3183, 3259, 3337, 3402, 3461, 3542, 3606, 3681, 3757, 3829, 3898, 3947, 4036,
       4097, 4166, 4226, 4304, 4372, 4446, 4499, 4570, 4620, 4690, 4742, 4792, 4829, 4869, 4912, 4952, 4981, 5020, 5039,
       5073, 5091, 5123, 5146, 5149, 5185, 5202, 5218, 5236, 5240, 5258, 5262, 5282, 5301, 5312, 5322, 5329, 5337, 5345,
       5349, 5368, 5366, 5373, 5377, 5387, 5401, 5400, 5408, 5420, 5428, 5438, 5422, 5435, 5447, 5450, 5453, 5456, 5460,
       5463, 5469, 5484, 5478, 5484, 5495, 5494, 5503, 5504, 5512, 5511, 5531, 5541, 5542, 5554, 5556, 5562, 5568, 5579,
       5575, 5588, 5591, 5593, 5594, 5586, 5604, 5617, 5609, 5623, 5628, 5627, 5640, 5652, 5663, 5654, 5656, 5673, 5674,
       5676, 5688, 5697, 5682, 5694, 5707, 5696, 5703, 5709, 5726, 5721, 5713, 5728, 5733, 5735, 5742, 5739, 5758, 5762,
       5768, 5767, 5770, 5786, 5782, 5804, 5806, 5791, 5801, 5821, 5823, 5831, 5821, 5829, 5829, 5840, 5848, 5845, 5844,
       5845, 5872, 5866, 5872, 5891, 5885, 5882, 5898, 5902, 5890, 5902, 5899, 5914, 5909, 5910, 5908, 5918, 5921, 5932,
       5947, 5940, 5946, 5951, 5950, 5963, 5971, 5964, 5980, 5984, 5986, 5982, 5993, 6007, 6007, 6001, 6014, 6016, 6022,
       6029, 6023, 6030, 6036, 6035, 6044, 6046, 6055, 6062, 6066, 6064, 6066, 6065, 6079, 6071, 6078, 6075, 6091, 6093,
       6099, 6104, 6110, 6104, 6110, 6117, 6124, 6135, 6126, 6135, 6134, 6131, 6142, 6130, 6156, 6162, 6150, 6165, 6167,
       6174, 6176, 6180, 6194, 6180, 6180, 6208, 6191, 6203, 6214, 6209, 6213, 6221, 6210, 6220, 6209, 6236, 6234, 6232,
       6238, 6249, 6253, 6250, 6254, 6256, 6275, 6268, 6291, 6285, 6272, 6284, 6279, 6300, 6289, 6309, 6296, 6323, 6309,
       6311, 6314, 6324, 6319, 6340, 6333, 6330, 6339, 6350, 6345, 6335, 6361, 6359, 6361, 6373, 6367, 6369, 6377, 6383,
       6380, 6384, 6390, 6396, 6393, 6402, 6395, 6404, 6413, 6402, 6424, 6423, 6418, 6432, 6432, 6442, 6447, 6447, 6450,
       6442, 6458, 6454, 6455, 6460, 6473, 6455, 6466, 6474, 6470, 6478, 6476, 6480, 6487, 6497, 6496, 6498, 6496, 6504,
       6506, 6512, 6511, 6504, 6518, 6525, 6527, 6516, 6542, 6539, 6542, 6547, 6551, 6556, 6541, 6551, 6556, 6556, 6566,
       6558, 6559, 6569, 6570, 6576, 6579, 6584, 6584, 6591, 6597, 6590, 6592, 6598, 6601, 6593, 6603, 6601, 6610, 6627,
       6609, 6605, 6623, 6621, 6623, 6633, 6636, 6634, 6641, 6645, 6645, 6655, 6645, 6653, 6665, 6663, 6671, 6686, 6679,
       6678, 6674, 6681, 6675, 6672, 6682, 6692, 6693, 6692, 6697, 6697, 6705, 6717, 6708, 6718, 6718, 6721, 6732, 6714,
       6723, 6732, 6730, 6740, 6736, 6739, 6748, 6747, 6748, 6750, 6755, 6754, 6762, 6772, 6757, 6766, 6765, 6774, 6768,
       6782, 6781, 6789, 6787, 6779, 6789, 6793, 6807, 6801, 6796, 6798, 6795, 6807, 6817, 6817, 6820, 6824, 6825, 6825,
       6834, 6830, 6833, 6834, 6842, 6832, 6858, 6851, 6849, 6863, 6856, 6854, 6855, 6859, 6871, 6867, 6867, 6876, 6872,
       6875, 6888, 6882, 6891, 6903, 6893, 6893, 6898, 6909, 6921, 6900, 6915, 6906, 6918, 6907, 6919, 6925, 6928, 6928,
       6919, 6918, 6921, 6939, 6939, 6942, 6946, 6952, 6948, 6948, 6947, 6962, 6950, 6962, 6964, 6966, 6972, 6971, 6970,
       6983, 6971, 6981, 6975, 6971, 6985, 6986, 6985, 6985, 7005, 6995, 7000, 7002, 7007, 7009, 7011, 7032, 7012, 7020,
       7022, 7032, 7021, 7034, 7027, 7028, 7032, 7029, 7031, 7039, 7042, 7051, 7042, 7044, 7053, 7062, 7054, 7061, 7060,
       7056, 7070, 7061, 7067, 7065, 7067, 7072, 7071, 7079, 7081, 7098, 7084, 7101, 7088, 7096, 7092, 7101, 7101, 7089,
       7102, 7112, 7117, 7113, 7114, 7125, 7109, 7105, 7119, 7122, 7136, 7122, 7121, 7127, 7127, 7122, 7137, 7133, 7133,
       7139, 7155, 7136, 7157, 7159, 7161, 7161, 7148, 7159, 7158, 7176, 7157, 7164, 7174, 7177, 7175, 7181, 7195, 7191,
       7189, 7165, 7188, 7178, 7185, 7187, 7194, 7190, 7203, 7192, 7195, 7194, 7198, 7211, 7203, 7213, 7219, 7217, 7207,
       7218, 7226, 7222, 7225, 7213, 7225, 7219, 7212, 7214, 7220, 7217, 7219, 7229, 7237, 7236, 7242, 7239, 7241, 7244,
       7240, 7237, 7230, 7241, 7232, 7246, 7242, 7238, 7236, 7253, 7257, 7248, 7254, 7259, 7272, 7268, 7268, 7265, 7261,
       7258, 7264, 7275, 7271, 7291, 7283, 7273, 7272, 7270, 7273, 7286, 7292, 7295, 7296, 7286, 7292, 7282, 7302, 7288,
       7295, 7303, 7296, 7305, 7300, 7301, 7317, 7299, 7299, 7299, 7305, 7298, 7319, 7307, 7312, 7317, 7318, 7316, 7308,
       7322, 7322, 7330, 7320, 7326, 7328, 7330, 7335, 7345, 7323, 7340, 7339, 7336, 7349, 7339, 7347, 7340, 7350, 7344,
       7356, 7338, 7356, 7347, 7353, 7354, 7358, 7358, 7347, 7347, 7364, 7363, 7355, 7362, 7364, 7369, 7363, 7366, 7360,
       7369, 7373, 7363, 7368, 7383, 7379, 7369, 7378, 7372, 7369, 7381, 7392, 7382, 7377, 7377, 7387, 7382, 7374, 7388,
       7386, 7392, 7381, 7405, 7379, 7393, 7395, 7386, 7395, 7390, 7400, 7397, 7392, 7396, 7400, 7415, 7401, 7400, 7392,
       7405, 7410, 7397, 7383, 7400, 7403, 7395, 7389, 7403, 7400, 7411, 7394, 7407, 7400, 7399, 7404, 7403, 7401, 7396,
       7399, 7400, 7402, 7399, 7400, 7401, 7405, 7396, 7400, 7400, 7411, 7404, 7401, 7410, 7392, 7408, 7401, 7414, 7406,
       7409, 7400, 7411, 7407, 7397, 7411, 7423, 7419, 7410, 7418, 7418, 7431, 7408, 7411, 7417, 7419, 7403, 7399, 7404,
       7421, 7415, 7410, 7410, 7406, 7416, 7410, 7403, 7421, 7410, 7407, 7413, 7407, 7412, 7405, 7418, 7407, 7398, 7407,
       7400, 7407, 7398, 7407, 7403, 7401, 7402, 7399, 7397, 7395, 7399, 7406, 7380, 7403, 7392, 7393, 7411, 7393, 7387,
       7389, 7389, 7384, 7374, 7394, 7399, 7392, 7377, 7386, 7386, 7392, 7392, 7374, 7377, 7372, 7374, 7379, 7374, 7380,
       7362, 7375, 7379, 7380, 7369, 7360, 7373, 7373, 7357, 7355, 7347, 7370, 7372, 7358, 7349, 7356, 7352, 7339, 7351,
       7335, 7339, 7339, 7350, 7351, 7358, 7345, 7334, 7343, 7331, 7344, 7347, 7332, 7336, 7336, 7340, 7337, 7319, 7330,
       7318, 7329, 7328, 7324, 7319, 7331, 7323, 7318, 7305, 7309, 7324, 7316, 7301, 7323, 7313, 7297, 7301, 7313, 7291,
       7295, 7305, 7303, 7295, 7277, 7294, 7286, 7301, 7295, 7290, 7293, 7302, 7285, 7280, 7276, 7293, 7273, 7283, 7266,
       7271, 7271, 7272, 7266, 7253, 7272, 7266, 7272, 7259, 7249, 7263, 7263, 7263, 7261, 7254, 7265, 7255, 7252, 7256,
       7245, 7235, 7234, 7238, 7240, 7229, 7230, 7223, 7227, 7229, 7224, 7228, 7226, 7219, 7217, 7214, 7208, 7207, 7204,
       7197, 7210, 7220, 7214, 7203, 7209, 7209, 7203, 7195, 7192, 7199, 7200, 7191, 7179, 7178, 7176, 7179, 7182, 7175,
       7168, 7170, 7162, 7172, 7166, 7168, 7170, 7164, 7162, 7160, 7160, 7153, 7147, 7162, 7144, 7135, 7159, 7142, 7126,
       7145, 7149, 7131, 7128, 7131, 7126, 7114, 7107, 7120, 7119, 7102, 7111, 7109, 7096, 7109, 7080, 7106, 7101, 7094,
       7103, 7087, 7091, 7098, 7087, 7092, 7069, 7062, 7078, 7077, 7079, 7078, 7069, 7072, 7065, 7068, 7065, 7058, 7063,
       7050, 7041, 7046, 7040, 7045, 7079, 7029, 7033, 7023, 7027, 7030, 7032, 7023, 7006, 7007, 6997, 7002, 6997, 7002,
       6993, 7005, 7009, 7000, 6993, 6981, 6975, 6980, 6973, 6973, 6961, 6946, 6933, 6908, 6917, 6909, 6885, 6903, 6900,
       6908, 6911, 6920, 6926, 6930, 6934, 6931, 6928, 6926, 6914, 6907, 6905, 6912, 6903, 6899, 6894, 6892, 6890, 6891,
       6875, 6877, 6870, 6860, 6861, 6861, 6850, 6859, 6864, 6840, 6842, 6829, 6838, 6834, 6841, 6834, 6822, 6821, 6816,
       6822, 6817, 6803, 6800, 6801, 6800, 6793, 6803, 6792, 6784, 6798, 6790, 6784, 6792, 6800, 6796, 6794, 6790, 6783,
       6781, 6779, 6763, 6770, 6763, 6785, 6755, 6777, 6772, 6768, 6760, 6742, 6753, 6754, 6761, 6765, 6749, 6766, 6756,
       6733, 6737, 6741, 6745, 6731, 6733, 6726, 6729, 6725, 6725, 6713, 6714, 6716, 6712, 6693, 6696, 6695, 6713, 6699,
       6692, 6676, 6699, 6687, 6675, 6673, 6671, 6682, 6667, 6675, 6665, 6654, 6659, 6652, 6646, 6652, 6639, 6647, 6641,
       6628, 6634, 6635, 6631, 6631, 6624, 6616, 6624, 6610, 6607, 6609, 6605, 6590, 6587, 6584, 6591, 6571, 6596, 6583,
       6581, 6563, 6577, 6568, 6569, 6552, 6551, 6556, 6554, 6544, 6529, 6538, 6528, 6530, 6528, 6517, 6519, 6513, 6523,
       6519, 6498, 6501, 6502, 6496, 6489, 6486, 6495, 6487, 6474, 6474, 6466, 6462, 6471, 6446, 6458, 6445, 6443, 6434,
       6435, 6434, 6427, 6437, 6425, 6431, 6432, 6413, 6407, 6412, 6394, 6403, 6398, 6397, 6391, 6394, 6382, 6379, 6380,
       6380, 6374, 6369, 6361, 6372, 6367, 6356, 6351, 6336, 6343, 6334, 6327, 6331, 6321, 6327, 6323, 6319, 6302, 6302,
       6304, 6306, 6307, 6295, 6287, 6306, 6292, 6291, 6273, 6275, 6265, 6272, 6261, 6251, 6245, 6240, 6248, 6245, 6239,
       6243, 6238, 6224, 6230, 6224, 6215, 6213, 6224, 6203, 6201, 6199, 6194, 6198, 6181, 6184, 6177, 6172, 6179, 6185,
       6167, 6160, 6150, 6152, 6161, 6146, 6145, 6127, 6133, 6145, 6124, 6117, 6118, 6118, 6105, 6096, 6102, 6092, 6083,
       6094, 6087, 6079, 6071, 6076, 6061, 6062, 6062, 6068, 6043, 6042, 6046, 6034, 6037, 6034, 6026, 6022, 6018, 6013,
       6012, 6012, 5994, 5997, 6002, 5996, 5987, 5974, 5983, 5970, 5972, 5977, 5957, 5966, 5956, 5955, 5950, 5946, 5939,
       5930, 5933, 5926, 5915, 5911, 5906, 5903, 5900, 5905, 5888, 5890, 5883, 5871, 5880, 5874, 5857, 5870, 5860, 5855,
       5843, 5839, 5837, 5833, 5827, 5834, 5824, 5820, 5829, 5807, 5814, 5814, 5801, 5791, 5779, 5783, 5781, 5770, 5773,
       5765, 5763, 5751, 5752, 5740, 5739, 5737, 5733, 5727, 5725, 5716, 5727, 5718, 5711, 5700, 5688, 5686, 5673, 5680,
       5689, 5664, 5670, 5664, 5669, 5663, 5655, 5634, 5643, 5652, 5631, 5641, 5631, 5622, 5626, 5618, 5609, 5610, 5613,
       5597, 5608, 5587, 5582, 5590, 5576, 5572, 5573, 5548, 5556, 5559, 5558, 5538, 5542, 5540, 5527, 5519, 5524, 5517,
       5508, 5509, 5496, 5496, 5496, 5485, 5484, 5484, 5466, 5460, 5455, 5456, 5442, 5443, 5434, 5433, 5429, 5422, 5430,
       5409, 5409, 5399, 5395, 5391, 5386, 5377, 5372, 5367, 5370, 5360, 5362, 5344, 5350, 5342, 5343, 5336, 5330, 5311,
       5311, 5299, 5313, 5301, 5291, 5290, 5287, 5271, 5265, 5263, 5259, 5251, 5242, 5232, 5215, 5218, 5210, 5203, 5188,
       5184, 5167, 5146, 5133, 5113, 5103, 5072, 5059, 5024, 5005, 4985, 4938, 4921, 4886, 4850, 4803, 4759, 4698, 4660,
       4591, 4535, 4468, 4429, 4355, 4294, 4224, 4172, 4113, 4047, 3978, 3916, 3863, 3795, 3732, 3669, 3604, 3539, 3477,
       3418, 3356, 3297, 3230, 3161, 3095, 3030, 2968, 2912, 2841, 2780, 2711, 2654, 2580, 2523, 2460, 2396, 2325, 2269,
       2201, 2143, 2073, 2009, 1943, 1885, 1821, 1765, 1688, 1630, 1569, 1511, 1446, 1385, 1317, 1259, 1203, 1145, 1085,
       1027, 968, 909, 854, 803, 749, 696, 652, 600, 556, 509, 471, 429, 394, 356, 327, 294, 270, 251, 233, 215, 208,
       200, 196, 193, 190, 185, 182, 185, 183, 183, 177, 182, 180, 174, 178, 173, 173, 171, 172, 175, 170, 169, 168,
       170, 169, 165, 166, 166, 162, 162, 166, 162, 160, 160, 155, 158, 161, 157, 156, 154, 159, 152, 155, 157, 155,
       155, 154, 158, 152, 154, 154, 153, 152, 150, 148, 147, 148, 146, 148, 146, 146, 146, 143, 143, 144, 138, 141,
       139, 142, 143, 139, 139, 141, 141, 133, 135, 135, 132, 133, 129, 129, 128, 127, 124, 123, 123, 120, 120, 117,
       116, 112, 112, 115, 111, 110, 109, 106, 108, 104, 109, 107, 105, 103, 100, 103, 101, 99, 96, 106, 95, 94, 95, 93,
       91, 90, 91, 87, 86, 89, 83, 82, 83, 83, 78, 80, 79, 77, 79, 74, 73, 76, 72, 70, 71, 71, 70, 72, 69, 65, 64, 64,
       63, 64, 61, 60, 61, 59, 60, 56, 57, 56, 54, 52, 53, 52, 50, 49, 47, 48, 44, 47, 48, 45, 42, 42, 41, 43, 40, 39,
       39, 37, 37, 35, 36, 34, 35, 33, 32, 31, 31, 29, 29, 26, 26, 28, 25, 24, 24, 24, 22, 21, 20, 19, 19, 18, 18, 16,
       15, 16, 14, 13, 14, 12, 11, 11, 10, 9, 9, 9, 8, 6, 5, 5, 4, 3, 3, 2, 2, 2, 0, 0]

print(f'arr #={len(arr)}')
d = np.diff(arr)
print(f'd={d[:50]}')
dd = np.diff(d)
print(f'dd={dd[:50]}')
# plt.figure(figsize=(10, 7))
# plt.plot(np.arange(2047), d)
# plt.plot(np.arange(2046), dd)
print(f'미분 변곡점 : {arr[d[max(d)]]}, {min(d)}')
plt.plot(arr)

for i in range(2046):
    if (d[i] != 0) and (d[i] == dd[i]):
        plt.plot(i, arr[i], 'o')

smooth = signal.savgol_filter(arr, 55, 3)
print('smooth=',smooth, 'type=',type(smooth))
print('np.gradient=',np.gradient(smooth), 'size=',np.gradient(smooth).size)
dxdy = signal.savgol_filter(np.gradient(smooth), 55, 3)
dx2dy2 = signal.savgol_filter(np.gradient(dxdy), 55, 3)
plt.subplot(121)
plt.plot(smooth, 'k')
plt.plot(np.where(dx2dy2 == dx2dy2.min()), smooth[np.where(dx2dy2 == dx2dy2.min())], 'ro')
plt.subplot(122)
plt.plot(dxdy, 'r', label='first derivate')
plt.plot(dx2dy2, 'b', label='second derivate')

변곡점=np.where(dx2dy2 == dx2dy2.min())[0][0]
print('변곡점=',변곡점, arr[변곡점])
plt.text(10, 50, f'{변곡점}, {arr[변곡점]}')
# plt.text(40, 65, r'Max :' + f'{max1}')
# plt.text(40, 60, r'Min :' + f'{min1}')

plt.legend()
plt.show()
